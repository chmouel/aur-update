name: AUR Package Updates

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)"
        required: false
        default: false
  push:
    branches:
      - main
      - master
    paths:
      - packages.json
      - updpkg.sh

permissions:
  contents: write

concurrency:
  group: aur-update-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install toolchain
        run: pacman -Syu --noconfirm --needed base-devel git jq curl npm openssh pacman-contrib

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          set-safe-directory: true

      - name: Prepare build user
        run: |
          id aurbuild &>/dev/null || useradd --create-home --shell /bin/bash aurbuild
          chown -R aurbuild:aurbuild "$GITHUB_WORKSPACE"

      - name: Setup SSH for AUR
        run: |
          install -d -m 700 /home/aurbuild/.ssh
          printf '%s\n' "${{ secrets.AUR_SSH_PRIVATE_KEY }}" >/home/aurbuild/.ssh/id_rsa
          tr -d '\r' </home/aurbuild/.ssh/id_rsa >/home/aurbuild/.ssh/id_rsa.tmp
          mv /home/aurbuild/.ssh/id_rsa.tmp /home/aurbuild/.ssh/id_rsa
          chmod 600 /home/aurbuild/.ssh/id_rsa
          chmod 600 /home/aurbuild/.ssh/id_rsa
          ssh-keyscan -H aur.archlinux.org >> /home/aurbuild/.ssh/known_hosts
          chown -R aurbuild:aurbuild /home/aurbuild/.ssh

      - name: Update all packages
        id: update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "${GITHUB_OUTPUT:-}" ]]; then
            touch "$GITHUB_OUTPUT"
            chown aurbuild:aurbuild "$GITHUB_OUTPUT"
          fi
          runuser --preserve-environment -u aurbuild -- bash <<'EOF'
          set -euo pipefail
          export HOME=/home/aurbuild
          cd "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          ./updpkg.sh --all
          EOF

      - name: Commit changes to this repository
        run: |
          set -xeuo pipefail
          cd "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore: update AUR packages"
            git push origin HEAD
          fi

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        with:
          detached: true
          limit-access-to-actor: true

      - name: Push updated packages to AUR
        env:
          GIT_SSH_COMMAND: "ssh -i /home/aurbuild/.ssh/id_rsa -o StrictHostKeyChecking=no"
        run: |
          runuser --preserve-environment -u aurbuild -- bash <<'EOF'
          set -xeuo pipefail
          export HOME=/home/aurbuild
          cd "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          jq -r '.[] | select(.enabled // true) | .name' packages.json | while read package_name; do
            package_path=$(jq -r --arg name "$package_name" '.[] | select(.name == $name) | .path' packages.json)

            echo "Processing $package_name from $package_path"

            if ! git diff HEAD~1 --quiet -- "$package_path" 2>/dev/null; then
              echo "Changes detected in $package_name, pushing to AUR..."

              aur_tmp="/tmp/aur-$package_name"
              git clone "ssh://aur@aur.archlinux.org/${package_name}.git" "$aur_tmp"

              cp -f "$package_path"/PKGBUILD "$aur_tmp/"
              cp -f "$package_path"/.SRCINFO "$aur_tmp/"

              cd "$aur_tmp"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              git add PKGBUILD .SRCINFO
              if ! git diff --staged --quiet; then
                pkgver=$(grep '^pkgver=' PKGBUILD | head -n1 | cut -d'=' -f2)
                git commit -m "Update to $pkgver"
                git push origin master
                echo "âœ“ Pushed $package_name to AUR"
              else
                echo "No changes to push for $package_name"
              fi

              cd -
              rm -rf "$aur_tmp"
            else
              echo "No changes in $package_name, skipping AUR push"
            fi
          done
          EOF
